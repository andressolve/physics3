<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Invisible Orchestra: How Sound Waves Create Our World</title>
    <style>
        /*
         * Reset and typography
         */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            line-height: 1.6;
            color: #333;
            background-color: #fafafa;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            font-size: 2.5em;
            color: #1a1a1a;
            margin-bottom: 0.3em;
            font-weight: normal;
            text-align: center;
        }

        .subtitle {
            font-size: 1.2em;
            color: #666;
            text-align: center;
            margin-bottom: 2em;
            font-style: italic;
        }

        .section {
            margin-bottom: 4em;
            background: white;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        h2 {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 0.8em;
            font-weight: normal;
        }

        p {
            font-size: 1.1em;
            margin-bottom: 1.5em;
            color: #444;
        }

        .interactive-box {
            background: #f5f7fa;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            padding: 2em;
            margin: 2em 0;
            position: relative;
        }

        .question-box {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 1.5em;
            margin: 2em 0;
            font-style: italic;
        }

        .fun-fact {
            background: #fff9e6;
            border-left: 4px solid #f39c12;
            padding: 1.5em;
            margin: 2em 0;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0.5em;
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        button:active {
            transform: translateY(0);
        }

        .canvas-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 1em 0;
            padding: 1em;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            border: 1px solid #eee;
            border-radius: 3px;
        }

        .slider-container {
            margin: 1.5em 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5em;
            font-size: 0.95em;
            color: #666;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #2980b9;
            transform: scale(1.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .choice-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1em;
            margin: 1em 0;
        }

        .choice-button {
            background: white;
            border: 2px solid #3498db;
            color: #3498db;
            padding: 1em;
            transition: all 0.3s ease;
        }

        .choice-button:hover {
            background: #3498db;
            color: white;
        }

        .reveal-text {
            display: none;
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 1.5em;
            margin-top: 1em;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .highlight {
            background: linear-gradient(to bottom, transparent 60%, #ffeb3b 60%);
            padding: 0 4px;
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            margin: 3em 0;
            gap: 0.5em;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            background: #ddd;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: #3498db;
            transform: scale(1.3);
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }
            .section {
                padding: 1.5em;
            }
            .choice-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>The Invisible Orchestra</h1>
        <p class="subtitle">How Sound Waves Create Our World</p>

        <!-- Opening Hook -->
        <div class="section">
            <p style="font-size: 1.2em; font-style: italic;">Right now, as you read this, thousands of invisible waves are bouncing around you. They're carrying conversations, music, and sounds from the world outside. But here's the wild part—<span class="highlight">sound doesn't actually travel through the air. The air itself becomes the sound!</span></p>
            
            <div class="question-box">
                <p>If you shout in space, would anyone hear you? Why or why not? Think about it for a moment...</p>
            </div>
        </div>

        <!-- Section 1: The Birth of a Sound -->
        <div class="section">
            <h2>The Birth of a Sound</h2>
            <p>Let's start with something simple: plucking a guitar string. When you pluck it, something amazing happens. The string doesn't just move—it vibrates back and forth hundreds of times per second!</p>
            
            <div class="interactive-box">
                <h3 style="text-align: center; margin-bottom: 1em;">Virtual Guitar String</h3>
                <div class="canvas-container">
                    <canvas id="stringCanvas" width="600" height="200"></canvas>
                </div>
                <div style="text-align: center;">
                    <button onclick="pluckString()">Pluck the String!</button>
                </div>
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Loose String (Low Pitch)</span>
                        <span>Tight String (High Pitch)</span>
                    </div>
                    <input type="range" id="tensionSlider" min="1" max="10" value="5" oninput="updateTension()">
                </div>
            </div>

            <div class="question-box">
                <p>What did you notice about how fast the string vibrates when you make it tighter?</p>
            </div>

            <p>Here's the secret: as the string vibrates, it pushes and pulls the air molecules around it. These molecules bump into their neighbors, which bump into their neighbors, creating a wave of compressed air that travels outward. <span class="highlight">That wave IS the sound!</span></p>

            <div style="text-align: center; margin: 2em 0;">
                <img src="phys3image1.png" alt="Vibrating guitar string showing air compression waves" style="max-width: 100%; height: auto; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            </div>
        </div>

        <!-- Section 2: Waves in Action -->
        <div class="section">
            <h2>Waves in Action</h2>
            <p>Sound waves have two main properties that determine what we hear:</p>
            <ul style="margin-left: 2em; margin-bottom: 1.5em;">
                <li style="margin-bottom: 0.5em;"><strong>Frequency</strong>: How many times the wave vibrates per second (this creates pitch)</li>
                <li><strong>Amplitude</strong>: How big the wave is (this creates volume)</li>
            </ul>

            <div class="interactive-box">
                <h3 style="text-align: center; margin-bottom: 1em;">Wave Generator</h3>
                <div class="canvas-container">
                    <canvas id="waveCanvas" width="600" height="300"></canvas>
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Low Pitch (Slow vibration)</span>
                        <span>High Pitch (Fast vibration)</span>
                    </div>
                    <input type="range" id="frequencySlider" min="1" max="20" value="5" oninput="updateWave()">
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Quiet (Small wave)</span>
                        <span>Loud (Big wave)</span>
                    </div>
                    <input type="range" id="amplitudeSlider" min="10" max="50" value="30" oninput="updateWave()">
                </div>
                
                <div style="text-align: center;">
                    <button onclick="playWaveSound()">Play This Sound!</button>
                    <button onclick="addSecondWave()">Add Another Wave</button>
                </div>
            </div>

            <!-- Optional educational diagram -->
            <div style="text-align: center; margin-top: 2em;">
                <img src="phys3image2.png" alt="Sound waves of different frequencies and amplitudes" style="max-width: 100%; height: auto; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            </div>

            <div class="fun-fact">
                <strong>Mind-blowing fact:</strong> A mosquito's wings beat about 600 times per second, creating that annoying high-pitched buzz. An elephant's rumble can be as low as 5 vibrations per second—so low that humans can't even hear it!
            </div>
        </div>

        <!-- Section 3: The Speed of Sound Race -->
        <div class="section">
            <h2>The Speed of Sound Race</h2>
            <p>Sound doesn't travel at the same speed through everything. In fact, it can travel 15 times faster through steel than through air! Let's race sound waves through different materials.</p>

            <div class="question-box">
                <p>Which do you think sound travels faster through—air or water? Make your prediction!</p>
            </div>

            <div class="interactive-box">
                <h3 style="text-align: center; margin-bottom: 1em;">Sound Speed Race</h3>
                <div class="canvas-container">
                    <canvas id="raceCanvas" width="600" height="400"></canvas>
                </div>
                <div style="text-align: center;">
                    <button onclick="startRace()">Start the Race!</button>
                    <button onclick="resetRace()">Reset</button>
                </div>
                <p style="text-align: center; margin-top: 1em; color: #666;">Click to see sound race through air, water, and steel!</p>
            </div>

            <p>Why is sound so much faster in solids? It's all about how close the molecules are to each other. In steel, molecules are packed tight like people in a crowded subway car—when one moves, it immediately bumps its neighbor. In air, molecules are far apart like people in an empty field—it takes longer for the motion to travel.</p>

            <div class="fun-fact">
                <strong>Real-world connection:</strong> This is why you can hear a train coming by putting your ear to the railroad track long before you can hear it through the air!
            </div>
        </div>

        <!-- Section 4: Echo Location -->
        <div class="section">
            <h2>Nature's Sonar System</h2>
            <p>Some animals have turned sound into a superpower. Bats and dolphins can "see" with sound by sending out clicks and listening to the echoes. This is called echolocation.</p>

            <div class="interactive-box">
                <h3 style="text-align: center; margin-bottom: 1em;">Be a Bat! Echolocation Simulator</h3>
                <div class="canvas-container">
                    <canvas id="echoCanvas" width="600" height="400"></canvas>
                </div>
                <div style="text-align: center;">
                    <button onclick="sendSonarPulse()">Send Sound Pulse</button>
                    <button onclick="toggleDarkMode()">Lights On/Off</button>
                </div>
                <p style="text-align: center; margin-top: 1em; color: #666;">Click to send out sound waves and "see" hidden objects!</p>
            </div>

            <div style="text-align: center; margin: 2em 0;">
                <img src="phys3image3.png" alt="Bat using echolocation to detect insects" style="max-width: 100%; height: auto; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            </div>
        </div>

        <!-- Section 5: Breaking the Sound Barrier -->
        <div class="section">
            <h2>Breaking the Rules: The Sound Barrier</h2>
            <p>What happens when something moves faster than sound itself? The results are spectacular—and loud!</p>

            <div class="interactive-box">
                <h3 style="text-align: center; margin-bottom: 1em;">Sonic Boom Simulator</h3>
                <div class="canvas-container">
                    <canvas id="sonicCanvas" width="600" height="300"></canvas>
                </div>
                <div style="text-align: center;">
                    <button onclick="startJet()">Launch the Jet!</button>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Slow</span>
                            <span>Speed of Sound</span>
                            <span>Supersonic!</span>
                        </div>
                        <input type="range" id="speedSlider" min="0.5" max="2" step="0.1" value="0.5" oninput="updateJetSpeed()">
                    </div>
                </div>
            </div>

            <p>When an object moves faster than sound, it creates a shock wave—like a boat creating a wake, but in three dimensions. All the sound waves pile up into one massive BOOM!</p>

            <div style="text-align: center; margin: 2em 0;">
                <img src="phys3image4.png" alt="Jet breaking the sound barrier with shock waves" style="max-width: 100%; height: auto; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            </div>
        </div>

        <!-- Section 6: Your Sound Laboratory -->
        <div class="section">
            <h2>Your Sound Laboratory</h2>
            <p>Now it's time to put everything you've learned together. Can you design an instrument that makes a specific sound?</p>

            <div class="interactive-box">
                <h3 style="text-align: center; margin-bottom: 1em;">Build Your Own Instrument</h3>
                
                <div style="margin: 1.5em 0;">
                    <h4>Choose Your Material:</h4>
                    <div class="choice-buttons">
                        <button class="choice-button" onclick="selectMaterial('wood')">Wood (Warm tone)</button>
                        <button class="choice-button" onclick="selectMaterial('metal')">Metal (Bright tone)</button>
                        <button class="choice-button" onclick="selectMaterial('glass')">Glass (Clear tone)</button>
                        <button class="choice-button" onclick="selectMaterial('plastic')">Plastic (Soft tone)</button>
                    </div>
                </div>
                
                <div style="margin: 1.5em 0;">
                    <h4>Choose Your Size:</h4>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Small (High pitch)</span>
                            <span>Large (Low pitch)</span>
                        </div>
                        <input type="range" id="sizeSlider" min="1" max="10" value="5">
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 2em;">
                    <button onclick="playInstrument()" style="background: #27ae60;">Play Your Creation!</button>
                </div>
            </div>

            <div class="question-box">
                <p>Musicians often say that the same note sounds different on different instruments. Based on what you've discovered, why do you think a middle C on a piano sounds different from a middle C on a guitar?</p>
            </div>
        </div>

        <!-- Final Challenge -->
        <div class="section">
            <h2>The Ultimate Challenge</h2>
            <p>You've discovered the secrets of sound! Let's see if you can apply what you've learned:</p>
            
            <div class="question-box">
                <p><strong>Challenge Question:</strong> You're at a fireworks show. The explosion happens directly overhead, but you see the flash 2 seconds before you hear the boom. Knowing that sound travels about 340 meters per second in air, approximately how high up was the explosion?</p>
                
                <div class="choice-buttons" style="margin-top: 1em;">
                    <button class="choice-button" onclick="checkAnswer('340')">340 meters</button>
                    <button class="choice-button" onclick="checkAnswer('680')">680 meters</button>
                    <button class="choice-button" onclick="checkAnswer('170')">170 meters</button>
                    <button class="choice-button" onclick="checkAnswer('1020')">1020 meters</button>
                </div>
                
                <div id="answerReveal" class="reveal-text"></div>
            </div>
            
            <div class="fun-fact" style="margin-top: 2em;">
                <h3>Your Sound Superpower</h3>
                <p>Congratulations! You now understand something that took humans thousands of years to figure out. You know that:</p>
                <ul style="margin-left: 1.5em; margin-top: 1em;">
                    <li>Sound is just wiggling air (or water, or metal...)</li>
                    <li>Faster wiggles = higher pitch</li>
                    <li>Bigger wiggles = louder sound</li>
                    <li>Sound needs something to travel through</li>
                    <li>Sound can be used to "see" in the dark</li>
                </ul>
                <p style="margin-top: 1em;">Next time you hear music, a voice, or even an annoying mosquito, remember—you're experiencing the invisible orchestra of vibrating molecules all around you!</p>
            </div>
        </div>

        <div class="progress-indicator">
            <div class="progress-dot active"></div>
            <div class="progress-dot active"></div>
            <div class="progress-dot active"></div>
            <div class="progress-dot active"></div>
            <div class="progress-dot active"></div>
            <div class="progress-dot active"></div>
        </div>
    </div>

    <script>

        // Canvas and drawing contexts
        let stringCanvas, stringCtx;
        let waveCanvas, waveCtx;
        let raceCanvas, raceCtx;
        let echoCanvas, echoCtx;
        let sonicCanvas, sonicCtx;

        // Audio context for sound generation
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Guitar string state
        let stringVibrating = false;
        let stringAmplitude = 0;
        let stringFrequency = 5;
        let stringTime = 0;

        // Wave generator state
        let waveFrequency = 5;
        let waveAmplitude = 30;
        let secondWave = false;
        let waveTime = 0;
        let waveAnimationId;

        // Race state
        let raceProgress = {air: 0, water: 0, steel: 0};
        let raceRunning = false;
        let raceInterval;

        // Echolocation state
        let echoPulses = [];
        let echoObjects = [
            {x: 400, y: 100, size: 30},
            {x: 200, y: 300, size: 25},
            {x: 500, y: 250, size: 40}
        ];
        let darkMode = false;

        // Sonic boom state
        let jetPosition = 0;
        let jetSpeed = 0.5;
        let soundWaves = [];
        let jetAnimating = false;

        // Instrument state
        let selectedMaterial = 'wood';
        let instrumentSize = 5;

        document.addEventListener('DOMContentLoaded', () => {
            // Grab canvases and contexts after DOM is ready
            stringCanvas = document.getElementById('stringCanvas');
            stringCtx = stringCanvas.getContext('2d');
            waveCanvas = document.getElementById('waveCanvas');
            waveCtx = waveCanvas.getContext('2d');
            raceCanvas = document.getElementById('raceCanvas');
            raceCtx = raceCanvas.getContext('2d');
            echoCanvas = document.getElementById('echoCanvas');
            echoCtx = echoCanvas.getContext('2d');
            sonicCanvas = document.getElementById('sonicCanvas');
            sonicCtx = sonicCanvas.getContext('2d');
            
            // Initial drawing
            drawWave();
            drawRaceInitial();
            drawEcho();
            drawSonic();
        });

        /*
         * Guitar string functions
         */
        function pluckString() {
            stringVibrating = true;
            stringAmplitude = 40;
            playStringSound();
            animateString();
        }

        function updateTension() {
            stringFrequency = parseInt(document.getElementById('tensionSlider').value);
        }

        function animateString() {
            if (!stringVibrating) return;
            // Clear canvas
            stringCtx.clearRect(0, 0, stringCanvas.width, stringCanvas.height);
            
            // Draw vibrating string as a fixed line with sine modulation
            stringCtx.beginPath();
            stringCtx.moveTo(50, 100);
            for (let x = 50; x <= 550; x += 5) {
                const relativeX = (x - 50) / 500;
                const y = 100 + Math.sin(relativeX * Math.PI) * stringAmplitude * Math.sin(stringTime * stringFrequency * 0.1);
                stringCtx.lineTo(x, y);
            }
            stringCtx.strokeStyle = '#8B4513';
            stringCtx.lineWidth = 3;
            stringCtx.stroke();
            
            // Draw fixed posts
            stringCtx.fillStyle = '#444';
            stringCtx.fillRect(40, 95, 20, 10);
            stringCtx.fillRect(540, 95, 20, 10);
            
            // Dampen amplitude
            stringAmplitude *= 0.98;
            stringTime++;
            
            if (stringAmplitude > 0.5) {
                requestAnimationFrame(animateString);
            } else {
                stringVibrating = false;
            }
        }

        function playStringSound() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.frequency.setValueAtTime(200 + stringFrequency * 40, audioContext.currentTime);
            oscillator.type = 'sawtooth';
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 1);
        }

        /*
         * Wave generator functions
         */
        function updateWave() {
            waveFrequency = parseInt(document.getElementById('frequencySlider').value);
            waveAmplitude = parseInt(document.getElementById('amplitudeSlider').value);
            drawWave();
        }

        function drawWave() {
            // Clear canvas
            waveCtx.clearRect(0, 0, waveCanvas.width, waveCanvas.height);
            
            // Draw main sine wave
            waveCtx.beginPath();
            waveCtx.moveTo(0, 150);
            for (let x = 0; x <= waveCanvas.width; x++) {
                const y = 150 + Math.sin((x + waveTime) * waveFrequency * 0.02) * waveAmplitude;
                waveCtx.lineTo(x, y);
            }
            waveCtx.strokeStyle = '#3498db';
            waveCtx.lineWidth = 3;
            waveCtx.stroke();
            
            // Draw second wave if toggled
            if (secondWave) {
                waveCtx.beginPath();
                waveCtx.moveTo(0, 150);
                for (let x = 0; x <= waveCanvas.width; x++) {
                    const y = 150 + Math.sin((x + waveTime) * waveFrequency * 0.015) * waveAmplitude * 0.7;
                    waveCtx.lineTo(x, y);
                }
                waveCtx.strokeStyle = '#e74c3c';
                waveCtx.lineWidth = 2;
                waveCtx.stroke();
            }
            
            // Draw center baseline
            waveCtx.beginPath();
            waveCtx.moveTo(0, 150);
            waveCtx.lineTo(waveCanvas.width, 150);
            waveCtx.strokeStyle = '#999';
            waveCtx.lineWidth = 1;
            waveCtx.setLineDash([5, 5]);
            waveCtx.stroke();
            waveCtx.setLineDash([]);
            
            // Draw labels
            waveCtx.fillStyle = '#666';
            waveCtx.font = '14px Arial';
            waveCtx.fillText(`Frequency: ${waveFrequency}`, 10, 20);
            waveCtx.fillText(`Amplitude: ${waveAmplitude}`, 10, 40);
        }

        function playWaveSound() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.frequency.setValueAtTime(100 + waveFrequency * 50, audioContext.currentTime);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(waveAmplitude / 200, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function addSecondWave() {
            secondWave = !secondWave;
            drawWave();
        }

        /*
         * Sound race functions
         */
        function drawRaceInitial() {
            // Clear entire canvas
            raceCtx.clearRect(0, 0, raceCanvas.width, raceCanvas.height);
            
            const lanes = [
                {name: 'Air', color: '#87CEEB', y: 100},
                {name: 'Water', color: '#4682B4', y: 200},
                {name: 'Steel', color: '#708090', y: 300}
            ];
            
            lanes.forEach(lane => {
                // Lane background
                raceCtx.fillStyle = lane.color + '20';
                raceCtx.fillRect(100, lane.y - 30, 400, 60);
                
                // Lane label
                raceCtx.fillStyle = '#333';
                raceCtx.font = 'bold 16px Arial';
                raceCtx.fillText(lane.name, 20, lane.y + 5);
                
                // Starting circles (at start of race)
                raceCtx.beginPath();
                raceCtx.arc(100, lane.y, 20, 0, Math.PI * 2);
                raceCtx.fillStyle = lane.color;
                raceCtx.fill();
            });
        }

        function startRace() {
            // Prevent starting multiple times
            if (raceRunning) return;
            raceRunning = true;
            raceProgress = {air: 0, water: 0, steel: 0};
            // Draw initial frame
            drawRaceFrame();
            // Clear any previous interval
            if (raceInterval) clearInterval(raceInterval);
            // Update positions at a regular cadence
            raceInterval = setInterval(() => {
                raceProgress.air += 1;
                raceProgress.water += 4.3;
                raceProgress.steel += 15;
                drawRaceFrame();
                if (raceProgress.air >= 400 && raceProgress.water >= 400 && raceProgress.steel >= 400) {
                    clearInterval(raceInterval);
                    raceRunning = false;
                }
            }, 30);
        }

        // Draw a single frame of the race based on current progress
        function drawRaceFrame() {
            // Clear canvas
            raceCtx.clearRect(0, 0, raceCanvas.width, raceCanvas.height);
            // Define lanes and speeds for drawing
            const lanes = [
                {id: 'air', color: '#87CEEB', y: 100},
                {id: 'water', color: '#4682B4', y: 200},
                {id: 'steel', color: '#708090', y: 300}
            ];
            // Draw lane backgrounds and labels
            lanes.forEach(lane => {
                raceCtx.fillStyle = lane.color + '20';
                raceCtx.fillRect(100, lane.y - 30, 400, 60);
                raceCtx.fillStyle = '#333';
                raceCtx.font = 'bold 16px Arial';
                raceCtx.fillText(lane.id.charAt(0).toUpperCase() + lane.id.slice(1), 20, lane.y + 5);
            });
            // Draw waves for each lane
            lanes.forEach(lane => {
                const progress = Math.min(raceProgress[lane.id], 400);
                raceCtx.beginPath();
                raceCtx.arc(100 + progress, lane.y, 20, 0, Math.PI * 2);
                raceCtx.fillStyle = lane.color;
                raceCtx.fill();
                // Draw a few rings around the wave
                for (let i = 1; i <= 3; i++) {
                    raceCtx.beginPath();
                    raceCtx.arc(100 + progress, lane.y, 20 + i * 10, 0, Math.PI * 2);
                    raceCtx.strokeStyle = lane.color;
                    raceCtx.globalAlpha = 0.3 - i * 0.07;
                    raceCtx.lineWidth = 1;
                    raceCtx.stroke();
                    raceCtx.globalAlpha = 1;
                }
            });
        }

        function resetRace() {
            raceRunning = false;
            raceProgress = {air: 0, water: 0, steel: 0};
            drawRaceInitial();
        }

        /*
         * Echolocation functions
         */
        function drawEcho() {
            echoCtx.clearRect(0, 0, echoCanvas.width, echoCanvas.height);
            
            if (darkMode) {
                echoCtx.fillStyle = '#000';
                echoCtx.fillRect(0, 0, echoCanvas.width, echoCanvas.height);
            }
            
            // Draw bat
            echoCtx.fillStyle = darkMode ? '#fff' : '#333';
            echoCtx.beginPath();
            echoCtx.arc(50, 200, 20, 0, Math.PI * 2);
            echoCtx.fill();
            
            // Draw bat wings
            echoCtx.beginPath();
            echoCtx.ellipse(35, 190, 15, 8, -0.3, 0, Math.PI * 2);
            echoCtx.ellipse(65, 190, 15, 8, 0.3, 0, Math.PI * 2);
            echoCtx.fill();
            
            // Draw objects (only if not in dark mode or if pulses have hit them)
            echoObjects.forEach(obj => {
                let visible = !darkMode;
                
                // Check if any pulse has hit this object
                echoPulses.forEach(pulse => {
                    const dist = Math.sqrt((pulse.x - obj.x) ** 2 + (pulse.y - obj.y) ** 2);
                    if (dist < obj.size && pulse.returning) {
                        visible = true;
                    }
                });
                
                if (visible) {
                    echoCtx.fillStyle = darkMode ? '#0f0' : '#e74c3c';
                    echoCtx.beginPath();
                    echoCtx.arc(obj.x, obj.y, obj.size, 0, Math.PI * 2);
                    echoCtx.fill();
                }
            });
            
            // Draw sound pulses
            echoPulses.forEach((pulse, index) => {
                echoCtx.strokeStyle = darkMode ? '#00f' : '#3498db';
                echoCtx.lineWidth = 2;
                echoCtx.globalAlpha = pulse.opacity;
                echoCtx.beginPath();
                echoCtx.arc(pulse.x, pulse.y, pulse.radius, 0, Math.PI * 2);
                echoCtx.stroke();
                echoCtx.globalAlpha = 1;
                
                // Update pulse
                if (!pulse.returning) {
                    pulse.radius += 3;
                    
                    // Check collision with objects
                    echoObjects.forEach(obj => {
                        const dist = Math.sqrt((pulse.x - obj.x) ** 2 + (pulse.y - obj.y) ** 2);
                        if (dist < obj.size + pulse.radius && dist > obj.size + pulse.radius - 6) {
                            // Create return pulse
                            echoPulses.push({
                                x: obj.x,
                                y: obj.y,
                                radius: 0,
                                opacity: 0.8,
                                returning: true
                            });
                        }
                    });
                    
                    if (pulse.radius > 300) {
                        pulse.opacity -= 0.02;
                    }
                } else {
                    // Returning pulse heads back to bat
                    const batX = 50, batY = 200;
                    const dx = batX - pulse.x;
                    const dy = batY - pulse.y;
                    const dist = Math.sqrt(dx ** 2 + dy ** 2);
                    
                    if (dist > 5) {
                        pulse.x += (dx / dist) * 3;
                        pulse.y += (dy / dist) * 3;
                    } else {
                        pulse.opacity -= 0.05;
                    }
                }
                
                if (pulse.opacity <= 0) {
                    echoPulses.splice(index, 1);
                }
            });
            
            requestAnimationFrame(drawEcho);
        }

        function sendSonarPulse() {
            echoPulses.push({
                x: 50,
                y: 200,
                radius: 0,
                opacity: 1,
                returning: false
            });
        }

        function toggleDarkMode() {
            darkMode = !darkMode;
        }

        /*
         * Sonic boom functions
         */
        function drawSonic() {
            // Draw an idle jet at start position with no animation
            sonicCtx.clearRect(0, 0, sonicCanvas.width, sonicCanvas.height);
            drawJet(50);
        }

        function startJet() {
            jetPosition = -50;
            jetAnimating = true;
            soundWaves = [];
            animateJet();
        }

        function animateJet() {
            if (!jetAnimating) return;
            drawSonic();
            requestAnimationFrame(animateJet);
        }

        function drawJet(x) {
            const y = sonicCanvas.height / 2;
            // Body
            sonicCtx.fillStyle = '#555';
            sonicCtx.fillRect(x, y - 10, 60, 20);
            // Nose
            sonicCtx.beginPath();
            sonicCtx.moveTo(x + 60, y - 10);
            sonicCtx.lineTo(x + 80, y);
            sonicCtx.lineTo(x + 60, y + 10);
            sonicCtx.closePath();
            sonicCtx.fill();
            // Tail wing
            sonicCtx.fillRect(x + 10, y - 20, 20, 10);
            sonicCtx.fillRect(x + 10, y + 10, 20, 10);
        }

        function updateJetSpeed() {
            jetSpeed = parseFloat(document.getElementById('speedSlider').value);
        }

        /*
         * Instrument builder functions
         */
        function selectMaterial(material) {
            selectedMaterial = material;
        }

        function playInstrument() {
            instrumentSize = parseInt(document.getElementById('sizeSlider').value);
            // Map material to a base frequency (arbitrary but distinct)
            const baseMap = {wood: 220, metal: 440, glass: 330, plastic: 280};
            const baseFreq = baseMap[selectedMaterial] || 220;
            // Larger instrument = lower frequency, smaller instrument = higher
            const sizeFactor = (11 - instrumentSize) / 10; // range ~0.1 to 1.0
            const frequency = baseFreq * sizeFactor;
            
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.frequency.setValueAtTime(frequency, audioContext.currentTime);
            osc.type = 'triangle';
            gain.gain.setValueAtTime(0.2, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start();
            osc.stop(audioContext.currentTime + 1);
        }

        /*
         * Final challenge answer checking
         */
        function checkAnswer(answer) {
            const reveal = document.getElementById('answerReveal');
            let message;
            if (answer === '680') {
                message = '<p><strong>Correct!</strong> The explosion was about 680 meters high. Sound travels roughly 340 meters every second, so 2 seconds × 340 m/s = 680 m.</p>';
            } else {
                message = '<p>Not quite. Remember that sound travels about 340 meters every second, so after 2 seconds it has traveled around 680 meters.</p>';
            }
            reveal.innerHTML = message;
            reveal.style.display = 'block';
        }
    

// Inserted from complete: drawSonic
function drawSonic() {
            sonicCtx.clearRect(0, 0, sonicCanvas.width, sonicCanvas.height);
            
            // Draw ground
            sonicCtx.fillStyle = '#8FBC8F';
            sonicCtx.fillRect(0, 250, sonicCanvas.width, 50);
            
            // Draw clouds
            sonicCtx.fillStyle = '#fff';
            for (let i = 0; i < 5; i++) {
                sonicCtx.beginPath();
                sonicCtx.arc(100 + i * 120, 50, 20, 0, Math.PI * 2);
                sonicCtx.fill();
            }
            
            if (jetAnimating) {
                // Draw jet
                sonicCtx.fillStyle = '#666';
                sonicCtx.fillRect(jetPosition, 140, 40, 15);
                sonicCtx.fillRect(jetPosition - 10, 145, 20, 5);
                
                // Draw sound waves
                soundWaves.forEach((wave, index) => {
                    sonicCtx.strokeStyle = '#3498db';
                    sonicCtx.lineWidth = 2;
                    sonicCtx.globalAlpha = wave.opacity;
                    sonicCtx.beginPath();
                    sonicCtx.arc(wave.x, wave.y, wave.radius, 0, Math.PI * 2);
                    sonicCtx.stroke();
                    sonicCtx.globalAlpha = 1;
                    
                    wave.radius += 2;
                    wave.opacity -= 0.01;
                    
                    if (wave.opacity <= 0) {
                        soundWaves.splice(index, 1);
                    }
                });
                
                // Create new sound waves
                if (Math.random() < 0.3) {
                    soundWaves.push({
                        x: jetPosition + 20,
                        y: 147,
                        radius: 0,
                        opacity: 0.8
                    });
                }
                
                // Draw shock waves if supersonic
                if (jetSpeed > 1) {
                    sonicCtx.strokeStyle = '#e74c3c';
                    sonicCtx.lineWidth = 3;
                    sonicCtx.beginPath();
                    sonicCtx.moveTo(jetPosition, 135);
                    sonicCtx.lineTo(jetPosition - 60, 100);
                    sonicCtx.moveTo(jetPosition, 160);
                    sonicCtx.lineTo(jetPosition - 60, 195);
                    sonicCtx.stroke();
                }
                
                jetPosition += jetSpeed * 3;
                
                if (jetPosition > sonicCanvas.width) {
                    jetAnimating = false;
                    jetPosition = -50;
                }
            } else {
                // Draw stationary jet
                sonicCtx.fillStyle = '#666';
                sonicCtx.fillRect(-30, 140, 40, 15);
                sonicCtx.fillRect(-40, 145, 20, 5);
            }
        }

</script>
</body>
</html>